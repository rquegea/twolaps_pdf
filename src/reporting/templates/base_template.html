<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ titulo }} - {{ periodo }}</title>
</head>
<body>
    <!-- PORTADA -->
    <div class="portada">
        <div class="portada-header">
            <h1 class="portada-titulo">{{ titulo }}</h1>
            <div class="portada-subtitulo">{{ mercado }} / {{ categoria }}</div>
        </div>
        <div class="portada-periodo">
            <div class="periodo-label">PERIODO</div>
            <div class="periodo-value">{{ periodo }}</div>
        </div>
        <div class="portada-footer">
            <div class="generado">Generado automáticamente</div>
            <div class="fecha">{{ fecha_generacion }}</div>
            <div class="powered">TwoLaps Intelligence Platform</div>
        </div>
    </div>

    <!-- DASHBOARD EJECUTIVO -->
    <div class="seccion dashboard">
        <h1 class="seccion-titulo">Dashboard Ejecutivo</h1>
        
        <div class="kpi-grid">
            {% if competencia.lider %}
            <div class="kpi-card">
                <div class="kpi-icon">🏆</div>
                <div class="kpi-titulo">Líder de Mercado</div>
                <div class="kpi-valor">{{ competencia.lider }}</div>
            </div>
            {% endif %}
            
            {% if metricas_calidad.oportunidades %}
            <div class="kpi-card success">
                <div class="kpi-icon">🎯</div>
                <div class="kpi-titulo">Oportunidades</div>
                <div class="kpi-valor">{{ metricas_calidad.oportunidades }}</div>
            </div>
            {% endif %}
            
            {% if metricas_calidad.riesgos %}
            <div class="kpi-card danger">
                <div class="kpi-icon">⚠️</div>
                <div class="kpi-titulo">Riesgos</div>
                <div class="kpi-valor">{{ metricas_calidad.riesgos }}</div>
            </div>
            {% endif %}
            
            {% if metricas_calidad.plan_acciones %}
            <div class="kpi-card info">
                <div class="kpi-icon">📋</div>
                <div class="kpi-titulo">Iniciativas</div>
                <div class="kpi-valor">{{ metricas_calidad.plan_acciones }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- RESUMEN EJECUTIVO - DESTACADO -->
    <div class="seccion executive-summary-highlight">
        <h1 class="seccion-titulo">Resumen Ejecutivo</h1>
        
        {% if resumen_ejecutivo.answer_first %}
        <div class="answer-first-box">
            <h2>La Respuesta</h2>
            <div class="answer-box">
                <div class="answer-icon">💡</div>
                <p class="answer-text">{{ resumen_ejecutivo.answer_first.the_answer }}</p>
            </div>
            <div class="answer-details">
                {% if resumen_ejecutivo.answer_first.the_why %}
                <h3>¿Por qué?</h3>
                <p>{{ resumen_ejecutivo.answer_first.the_why|safe|replace('\n', '<br>') }}</p>
                {% endif %}
                {% if resumen_ejecutivo.answer_first.the_how %}
                <h3>¿Cómo?</h3>
                <p>{{ resumen_ejecutivo.answer_first.the_how|safe|replace('\n', '<br>') }}</p>
                {% endif %}
                {% if resumen_ejecutivo.answer_first.the_impact %}
                <h3>Impacto Esperado</h3>
                <p>{{ resumen_ejecutivo.answer_first.the_impact|safe|replace('\n', '<br>') }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if resumen_ejecutivo.recomendacion_principal %}
        <div class="recommendation-box">
            <div class="rec-title">Recomendación Principal</div>
            <div class="rec-content narrative-text">{{ resumen_ejecutivo.recomendacion_principal|safe|replace('\n', '<br>') }}</div>
        </div>
        {% endif %}
        
        {# NUEVO: Narrativa principal - contenido principal del resumen #}
        {% if resumen_ejecutivo.narrativa_principal %}
        <div class="narrativa-principal">
            <p class="narrative-text">{{ resumen_ejecutivo.narrativa_principal|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% elif resumen_ejecutivo.contexto %}
        <p class="contexto">{{ resumen_ejecutivo.contexto }}</p>
        {% endif %}
        
        {% if resumen_ejecutivo.hallazgos_clave %}
        <h2>Hallazgos Clave</h2>
        <ul class="hallazgos">
            {% for hallazgo in resumen_ejecutivo.hallazgos_clave %}
            <li>{{ hallazgo }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <!-- PANORAMA DEL MERCADO - NARRATIVO -->
    {% if panorama_mercado %}
    <div class="seccion">
        <h1 class="seccion-titulo">Panorama del Mercado</h1>
        
        {# NUEVO: Narrativa del mercado - contenido principal #}
        {% if panorama_mercado.narrativa %}
        <div class="narrativa-mercado">
            <p class="narrative-text">{{ panorama_mercado.narrativa|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua si no hay narrativa #}
        {% if panorama_mercado.contexto_fmcg %}
        <p class="contexto">{{ panorama_mercado.contexto_fmcg }}</p>
        {% endif %}
        
        {% if panorama_mercado.tamano_crecimiento %}
        <div class="kpi-box">
            <div class="kpi-label">Tamaño y Crecimiento del Mercado</div>
            <div class="kpi-value">{{ panorama_mercado.tamano_crecimiento }}</div>
        </div>
        {% endif %}
        
        <!-- Subsección: Drivers de Categoría -->
        {% if panorama_mercado.drivers_principales %}
        <div class="subseccion-mercado">
            <h2>Drivers de Categoría</h2>
            <ul class="drivers-list">
                {% for driver in panorama_mercado.drivers_principales %}
                <li>{{ driver }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <!-- Subsección: Análisis PESTEL -->
        {% if panorama_mercado.factores_pestel_clave %}
        <div class="subseccion-mercado">
            <h2>Factores PESTEL Clave</h2>
            <p style="font-style: italic; color: #666; font-size: 10pt;">
                Análisis del entorno macro que impacta la categoría
            </p>
            <ul>
                {% for factor in panorama_mercado.factores_pestel_clave %}
                <li>{{ factor }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <!-- Subsección: Fuerzas de Porter -->
        {% if panorama_mercado.fuerzas_competitivas %}
        <div class="subseccion-mercado">
            <h2>Fuerzas Competitivas (Porter)</h2>
            <p style="font-style: italic; color: #666; font-size: 10pt;">
                Análisis de la estructura competitiva de la industria
            </p>
            <p>{{ panorama_mercado.fuerzas_competitivas }}</p>
        </div>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}

    <!-- ESTADO DEL MERCADO -->
    <div class="seccion">
        <h1 class="seccion-titulo">Estado del Mercado</h1>
        
        {% if mercado_section.estado_general %}
        <p>{{ mercado_section.estado_general }}</p>
        {% endif %}
        
        {% if mercado_section.volumen_conversacion %}
        <div class="kpi-box">
            <div class="kpi-label">Volumen de Conversación</div>
            <div class="kpi-value">{{ mercado_section.volumen_conversacion }}</div>
            <div class="kpi-unit">menciones totales</div>
        </div>
        {% endif %}
        
        {% if mercado_section.principales_temas %}
        <h2>Principales Temas</h2>
        <ul>
            {% for tema in mercado_section.principales_temas %}
            <li>{{ tema }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <!-- ANÁLISIS COMPETITIVO - NARRATIVO -->
    <div class="seccion">
        <h1 class="seccion-titulo">Análisis Competitivo</h1>
        
        {% if charts.sov_chart %}
        <div class="chart-container">
            <img src="{{ charts.sov_chart }}" alt="Share of Voice" class="chart-img">
            <div class="chart-caption">
                Gráfico 1: Distribución de Share of Voice por marca en el periodo analizado
            </div>
        </div>
        {% endif %}
        
        {% if charts.sov_pie_chart %}
        <div class="chart-container">
            <img src="{{ charts.sov_pie_chart }}" alt="Share of Voice - Pie Chart" class="chart-img">
            <div class="chart-caption">
                Gráfico 2: Proporción del Share of Voice por marca
            </div>
        </div>
        {% endif %}
        
        {% if charts.sov_trend_chart %}
        <div class="chart-container">
            <img src="{{ charts.sov_trend_chart }}" alt="Evolución Share of Voice" class="chart-img">
            <div class="chart-caption">
                Gráfico 3: Evolución temporal del Share of Voice por marca
            </div>
        </div>
        {% endif %}
        {% if charts.waterfall_chart %}
        <div class="chart-container">
            <img src="{{ charts.waterfall_chart }}" alt="Waterfall SOV" class="chart-img">
            <div class="chart-caption">
                Gráfico 4: Waterfall de cambios en SOV por drivers
            </div>
        </div>
        {% endif %}
        
        {# NUEVO: Narrativa de dinámica competitiva - contenido principal #}
        {% if analisis_competitivo.narrativa_dinamica %}
        <div class="narrativa-competitiva">
            <h2>Dinámica Competitiva</h2>
            <p class="narrative-text">{{ analisis_competitivo.narrativa_dinamica|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua #}
        {% if competencia.lider %}
        <div class="lider-box">
            <strong>Líder del Mercado:</strong> {{ competencia.lider }}
        </div>
        {% endif %}
        
        {% if competencia.analisis_sov %}
        <p>{{ competencia.analisis_sov }}</p>
        {% if charts.sov_chart %}
        <p style="font-style: italic; color: #666;">
            (Ver Gráfico 1: Share of Voice para visualización detallada de la distribución)
        </p>
        {% endif %}
        {% endif %}
        
        {% if competencia.comparativas %}
        <h2>Análisis Comparativo</h2>
        <ul>
            {% for comp in competencia.comparativas %}
            <li>{{ comp }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
        
        {# NUEVO: Perfiles narrativos de competidores principales #}
        {% if analisis_competitivo.perfiles_narrativos %}
        <h2>Perfiles de Competidores</h2>
        {% for perfil in analisis_competitivo.perfiles_narrativos %}
        <div class="perfil-competidor">
            <h3>{{ perfil.marca }}</h3>
            <div class="perfil-analisis">
                <p class="narrative-text">{{ perfil.analisis_profundo|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        {% if charts.attribute_radar %}
        <div class="chart-container">
            <img src="{{ charts.attribute_radar }}" alt="Radar de Atributos" class="chart-img">
            <div class="chart-caption">
                Gráfico 9: Radar de atributos percibidos por marca
            </div>
        </div>
        {% endif %}
        
        <!-- NUEVO: Actividad de Marketing y Campañas -->
        {% if actividad_marketing %}
        <h2>📢 Actividad de Marketing y Campañas</h2>
        
        {% if actividad_marketing.resumen %}
        <p>{{ actividad_marketing.resumen }}</p>
        {% endif %}
        
        <div class="marketing-grid">
            {% if actividad_marketing.marca_mas_activa %}
            <div class="marketing-card">
                <strong>Marca Más Activa:</strong> {{ actividad_marketing.marca_mas_activa }}
            </div>
            {% endif %}
            
            {% if actividad_marketing.efectividad_percibida %}
            <div class="marketing-card">
                <strong>Efectividad:</strong> {{ actividad_marketing.efectividad_percibida }}
            </div>
            {% endif %}
        </div>
        
        {% if actividad_marketing.insights %}
        <h3>Insights de Marketing</h3>
        <ul>
            {% for insight in actividad_marketing.insights %}
            <li>{{ insight }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
        
        <!-- NUEVO: Estrategias de Canal -->
        {% if estrategias_canal %}
        <h2>🛒 Estrategias de Canal y Distribución</h2>
        
        {% if estrategias_canal.resumen %}
        <p>{{ estrategias_canal.resumen }}</p>
        {% endif %}
        
        <div class="canal-grid">
            {% if estrategias_canal.marca_mejor_distribuida %}
            <div class="canal-card">
                <strong>Mejor Presencia:</strong> {{ estrategias_canal.marca_mejor_distribuida }}
            </div>
            {% endif %}
            
            {% if estrategias_canal.tendencias %}
            <div class="canal-card">
                <strong>Tendencias:</strong> {{ estrategias_canal.tendencias }}
            </div>
            {% endif %}
        </div>
        
        {% if estrategias_canal.insights %}
        <h3>Insights de Canal</h3>
        <ul>
            {% for insight in estrategias_canal.insights %}
            <li>{{ insight }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
        
        {% if charts.channel_penetration %}
        <div class="chart-container">
            <img src="{{ charts.channel_penetration }}" alt="Penetración por Canal" class="chart-img">
            <div class="chart-caption">
                Gráfico 10: Penetración por canal de distribución por marca
            </div>
        </div>
        {% endif %}

        {% if charts.perceptual_map %}
        <div class="chart-container">
            <img src="{{ charts.perceptual_map }}" alt="Mapa Perceptual" class="chart-img">
            <div class="chart-caption">
                Gráfico 11: Mapa perceptual Precio vs Calidad (tamaño = SOV)
            </div>
        </div>
        {% endif %}
        {% if charts.bcg_matrix %}
        <div class="chart-container">
            <img src="{{ charts.bcg_matrix }}" alt="Matriz BCG" class="chart-img">
            <div class="chart-caption">
                Gráfico 12: Matriz BCG (Share vs Growth)
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ANÁLISIS DE CAMPAÑAS Y MARKETING (FMCG) - NARRATIVO -->
    {% if tipo_mercado == 'FMCG' and analisis_campanas %}
    <div class="seccion">
        <h1 class="seccion-titulo">📢 Análisis de Campañas y Marketing</h1>
        
        {# NUEVO: Narrativa de campañas #}
        {% if analisis_campanas.narrativa %}
        <div class="narrativa-campanas">
            <p class="narrative-text">{{ analisis_campanas.narrativa|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua #}
        {% if analisis_campanas.resumen_actividad %}
        <p class="contexto">{{ analisis_campanas.resumen_actividad }}</p>
        {% endif %}
        
        <div class="kpi-grid">
            {% if analisis_campanas.marca_mas_activa %}
            <div class="kpi-card success">
                <div class="kpi-icon">🏆</div>
                <div class="kpi-titulo">Marca Más Activa</div>
                <div class="kpi-valor">{{ analisis_campanas.marca_mas_activa }}</div>
            </div>
            {% endif %}
        </div>
        
        {% if analisis_campanas.insights_recepcion %}
        <h2>Insights de Recepción</h2>
        <ul class="insights-list">
            {% for insight in analisis_campanas.insights_recepcion %}
            <li>{{ insight }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}

    <!-- ANÁLISIS DE CANALES Y DISTRIBUCIÓN (FMCG) - NARRATIVO -->
    {% if tipo_mercado == 'FMCG' and analisis_canales %}
    <div class="seccion">
        <h1 class="seccion-titulo">🛒 Análisis de Canales y Distribución</h1>
        
        {# NUEVO: Narrativa de canales #}
        {% if analisis_canales.narrativa %}
        <div class="narrativa-canales">
            <p class="narrative-text">{{ analisis_canales.narrativa|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua #}
        {% if analisis_canales.estrategia_canal_inferida %}
        <p class="contexto">{{ analisis_canales.estrategia_canal_inferida }}</p>
        {% endif %}
        
        <div class="kpi-grid">
            {% if analisis_canales.marca_mejor_distribuida %}
            <div class="kpi-card info">
                <div class="kpi-icon">📦</div>
                <div class="kpi-titulo">Mejor Presencia Omnicanal</div>
                <div class="kpi-valor">{{ analisis_canales.marca_mejor_distribuida }}</div>
            </div>
            {% endif %}
        </div>
        
        {% if analisis_canales.gaps_e_commerce %}
        <h2>Gaps de E-commerce</h2>
        <ul class="gaps-list">
            {% for gap in analisis_canales.gaps_e_commerce %}
            <li>{{ gap }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}

    <!-- ANÁLISIS DE SOSTENIBILIDAD Y PACKAGING (FMCG) - NARRATIVO -->
    {% if tipo_mercado == 'FMCG' and analisis_sostenibilidad_packaging %}
    <div class="seccion">
        <h1 class="seccion-titulo">🌱 Análisis de Sostenibilidad y Packaging</h1>
        
        {# NUEVO: Narrativa de sostenibilidad y packaging #}
        {% if analisis_sostenibilidad_packaging.narrativa %}
        <div class="narrativa-sostenibilidad">
            <p class="narrative-text">{{ analisis_sostenibilidad_packaging.narrativa|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua #}
        <!-- Subsección ESG -->
        {% if analisis_sostenibilidad_packaging.resumen_esg %}
        <h2>Sostenibilidad (ESG)</h2>
        <p class="contexto">{{ analisis_sostenibilidad_packaging.resumen_esg }}</p>
        
        {% if analisis_sostenibilidad_packaging.controversias_clave %}
        <h3>Controversias Clave</h3>
        <ul class="controversias-list">
            {% for controversia in analisis_sostenibilidad_packaging.controversias_clave %}
            <li class="warning">{{ controversia }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
        
        <!-- Subsección Packaging -->
        {% if analisis_sostenibilidad_packaging.quejas_packaging %}
        <h2>Packaging y Diseño</h2>
        <p>{{ analisis_sostenibilidad_packaging.quejas_packaging }}</p>
        {% endif %}
        
        {% if analisis_sostenibilidad_packaging.atributos_valorados %}
        <h3>Atributos Valorados</h3>
        <ul class="atributos-list">
            {% for atributo in analisis_sostenibilidad_packaging.atributos_valorados %}
            <li class="success">{{ atributo }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if analisis_sostenibilidad_packaging.benchmarking_atributos %}
        <h3>Benchmarking</h3>
        <ul>
            {% for benchmark in analisis_sostenibilidad_packaging.benchmarking_atributos %}
            <li>{{ benchmark }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
        
        {% if charts.esg_leadership %}
        <div class="chart-container">
            <img src="{{ charts.esg_leadership }}" alt="Liderazgo ESG" class="chart-img">
            <div class="chart-caption">
                Gráfico 10: Matriz de liderazgo ESG (Share of Voice vs Score ESG, tamaño = Sentimiento)
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- ANÁLISIS DEL CONSUMIDOR - NARRATIVO -->
    {% if consumidor %}
    <div class="seccion">
        <h1 class="seccion-titulo">Análisis del Consumidor</h1>
        
        {# NUEVO: Narrativa de voz del cliente #}
        {% if consumidor.narrativa_voz_cliente %}
        <div class="narrativa-consumidor">
            <p class="narrative-text">{{ consumidor.narrativa_voz_cliente|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua #}
        {% if consumidor.voz_cliente_resumen %}
        <h2>Voz del Cliente</h2>
        <p>{{ consumidor.voz_cliente_resumen }}</p>
        {% endif %}
        
        {% if consumidor.drivers_eleccion %}
        <h2>Drivers de Elección</h2>
        <ul class="drivers-list">
            {% for driver in consumidor.drivers_eleccion %}
            <li>{{ driver }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if consumidor.barreras_compra %}
        <h2>Barreras de Compra</h2>
        <ul>
            {% for barrera in consumidor.barreras_compra %}
            <li>{{ barrera }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if consumidor.ocasiones_principales %}
        <h2>Ocasiones de Consumo</h2>
        <ul>
            {% for ocasion in consumidor.ocasiones_principales %}
            <li>{{ ocasion }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}
    
    <!-- CUSTOMER JOURNEY & BUYER PERSONAS -->
    <div class="seccion">
        <h1 class="seccion-titulo">Customer Journey & Buyer Personas</h1>

        {% if customer_journey and customer_journey.narrativa %}
        <div class="narrativa-journey">
            <p class="narrative-text">{{ customer_journey.narrativa|safe|replace('\n\n', '</p><p class=\"narrative-text\">')|replace('\n', '<br>') }}</p>
        </div>
        {% endif %}

        {% if customer_journey %}
            <h2>Customer Journey Map</h2>
            {% if charts.customer_journey_map_image %}
            <div class="chart-container">
                <img src="{{ charts.customer_journey_map_image }}" class="chart-img">
                <div class="chart-caption">Mapa del Customer Journey</div>
            </div>
            {% endif %}

            {% if customer_journey.stages %}
            <div class="journey-stages">
                {% for stage in customer_journey.stages %}
                <div class="stage-box">
                    <h3>{{ stage.name }}</h3>
                    {% if stage.pain_points %}<p><strong>Pain Points:</strong> {{ stage.pain_points | join(', ') if stage.pain_points is iterable else stage.pain_points }}</p>{% endif %}
                    {% if stage.touchpoints %}<p><strong>Touchpoints:</strong> {{ stage.touchpoints | join(', ') if stage.touchpoints is iterable else stage.touchpoints }}</p>{% endif %}
                    {% if stage.insights %}<p><strong>Insights:</strong> {{ stage.insights }}</p>{% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endif %}

        {% if buyer_personas %}
            <h2>Buyer Personas</h2>
            {% for persona in buyer_personas %}
            <div class="persona-card">
                <div class="persona-header">
                    <h3>{{ persona.name }}{% if persona.segment_name %} ({{ persona.segment_name }}){% endif %}</h3>
                    {% if persona.market_percentage %}
                    <span class="persona-size">{{ persona.market_percentage }}% del mercado</span>
                    {% endif %}
                </div>
                <div class="persona-details">
                    {% if persona.demographics %}<p><strong>Demografía:</strong> {{ persona.demographics }}</p>{% endif %}
                    {% if persona.motivations %}<p><strong>Motivaciones:</strong> {{ persona.motivations | join(', ') if persona.motivations is iterable else persona.motivations }}</p>{% endif %}
                    {% if persona.pain_points %}<p><strong>Pain Points:</strong> {{ persona.pain_points | join(', ') if persona.pain_points is iterable else persona.pain_points }}</p>{% endif %}
                    {% if persona.preferred_brands %}<p><strong>Marcas Preferidas:</strong> {{ persona.preferred_brands | join(', ') }}</p>{% endif %}
                    {% if persona.channels %}<p><strong>Canales Usados:</strong> {{ persona.channels | join(', ') }}</p>{% endif %}
                </div>
            </div>
            {% endfor %}
        {% elif customer_journey and customer_journey.buyer_personas %}
            <h2>Buyer Personas</h2>
            {% for persona in customer_journey.buyer_personas %}
            <div class="persona-card">
                <div class="persona-header">
                    <h3>{{ persona.name }}{% if persona.segment_name %} ({{ persona.segment_name }}){% endif %}</h3>
                    {% if persona.market_percentage %}
                    <span class="persona-size">{{ persona.market_percentage }}% del mercado</span>
                    {% endif %}
                </div>
                <div class="persona-details">
                    {% if persona.demographics %}<p><strong>Demografía:</strong> {{ persona.demographics }}</p>{% endif %}
                    {% if persona.motivations %}<p><strong>Motivaciones:</strong> {{ persona.motivations | join(', ') if persona.motivations is iterable else persona.motivations }}</p>{% endif %}
                    {% if persona.pain_points %}<p><strong>Pain Points:</strong> {{ persona.pain_points | join(', ') if persona.pain_points is iterable else persona.pain_points }}</p>{% endif %}
                    {% if persona.preferred_brands %}<p><strong>Marcas Preferidas:</strong> {{ persona.preferred_brands | join(', ') }}</p>{% endif %}
                    {% if persona.channels %}<p><strong>Canales Usados:</strong> {{ persona.channels | join(', ') }}</p>{% endif %}
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- SENTIMIENTO Y REPUTACIÓN - NARRATIVO -->
    <div class="seccion">
        <h1 class="seccion-titulo">Sentimiento y Reputación</h1>
        
        {% if charts.sentiment_chart %}
        <div class="chart-container">
            <img src="{{ charts.sentiment_chart }}" alt="Análisis de Sentimiento" class="chart-img">
            <div class="chart-caption">
                Gráfico 4: Análisis de Sentimiento por marca (escala -1 a +1)
            </div>
        </div>
        {% endif %}
        
        {% if charts.sentiment_trend_chart %}
        <div class="chart-container">
            <img src="{{ charts.sentiment_trend_chart }}" alt="Evolución del Sentimiento" class="chart-img">
            <div class="chart-caption">
                Gráfico 5: Evolución temporal del sentimiento por marca
            </div>
        </div>
        {% endif %}
        
        {# NUEVO: Narrativa de sentimiento #}
        {% if sentimiento_reputacion.narrativa %}
        <div class="narrativa-sentimiento">
            <p class="narrative-text">{{ sentimiento_reputacion.narrativa|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% elif sentimiento.narrativa %}
        <div class="narrativa-sentimiento">
            <p class="narrative-text">{{ sentimiento.narrativa|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% else %}
        {# Fallback a estructura antigua #}
        {% if sentimiento.resumen %}
        <p>{{ sentimiento.resumen }}</p>
        {% endif %}
        
        {% if sentimiento.por_marca_destacado %}
        <h2>Análisis por Marca</h2>
        {% if charts.sentiment_chart %}
        <p style="font-style: italic; color: #666;">
            Como muestra el Gráfico 2, el análisis de sentimiento revela los siguientes patrones por marca:
        </p>
        {% endif %}
        <ul>
            {% for analisis in sentimiento.por_marca_destacado %}
            <li>{{ analisis }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endif %}
    </div>

    <!-- OPORTUNIDADES Y RIESGOS - NARRATIVO -->
    <div class="seccion">
        <h1 class="seccion-titulo">Oportunidades y Riesgos</h1>
        
        {% if charts.opportunity_matrix %}
        <h2 class="oportunidades-titulo">🎯 Matriz de Oportunidades</h2>
        <div class="chart-container">
            <img src="{{ charts.opportunity_matrix }}" alt="Matriz de Oportunidades" class="chart-img">
            <div class="chart-caption">
                Gráfico 6: Matriz de priorización de oportunidades (Impacto vs Esfuerzo)
            </div>
        </div>
        {% endif %}
        
        {# NUEVO: Narrativa de oportunidades #}
        {% if oportunidades_riesgos.narrativa_oportunidades %}
        <h2 class="oportunidades-titulo">Análisis de Oportunidades</h2>
        <div class="narrativa-oportunidades">
            <p class="narrative-text">{{ oportunidades_riesgos.narrativa_oportunidades|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% endif %}
        
        {% if oportunidades_riesgos.oportunidades %}
        <h2 class="oportunidades-titulo">Detalle de Oportunidades</h2>
        {% for opp in oportunidades_riesgos.oportunidades %}
        <div class="oportunidad-box">
            <div class="oportunidad-titulo">{{ opp.titulo }}</div>
            <p class="oportunidad-desc">{{ opp.descripcion }}</p>
            <div class="oportunidad-meta">
                <span class="prioridad prioridad-{{ opp.prioridad|lower }}">Prioridad: {{ opp.prioridad }}</span>
                <span class="impacto">Impacto: {{ opp.impacto }}</span>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        {% if charts.risk_matrix %}
        <h2 class="riesgos-titulo">⚠️ Matriz de Riesgos</h2>
        <div class="chart-container">
            <img src="{{ charts.risk_matrix }}" alt="Matriz de Riesgos" class="chart-img">
            <div class="chart-caption">
                Gráfico 7: Matriz de evaluación de riesgos (Probabilidad vs Severidad)
            </div>
        </div>
        {% endif %}
        
        {# NUEVO: Narrativa de riesgos #}
        {% if oportunidades_riesgos.narrativa_riesgos %}
        <h2 class="riesgos-titulo">Análisis de Riesgos</h2>
        <div class="narrativa-riesgos">
            <p class="narrative-text">{{ oportunidades_riesgos.narrativa_riesgos|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% endif %}
        
        {% if oportunidades_riesgos.riesgos %}
        <h2 class="riesgos-titulo">Detalle de Riesgos</h2>
        {% for riesgo in oportunidades_riesgos.riesgos %}
        <div class="riesgo-box">
            <div class="riesgo-titulo">{{ riesgo.titulo }}</div>
            <p class="riesgo-desc">{{ riesgo.descripcion }}</p>
            <div class="riesgo-meta">
                <span class="probabilidad">Probabilidad: {{ riesgo.probabilidad }}</span>
                <span class="severidad">Severidad: {{ riesgo.severidad }}</span>
            </div>
            {% if riesgo.mitigacion %}
            <div class="mitigacion">
                <strong>Mitigación:</strong> {{ riesgo.mitigacion }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}
        
        {# NUEVO: DAFO con cruces estratégicos #}
        {% if oportunidades_riesgos.dafo_sintesis %}
        <h2>Análisis DAFO</h2>
        {% if oportunidades_riesgos.dafo_sintesis.cruces_estrategicos %}
        <div class="narrativa-dafo">
            <p class="narrative-text">{{ oportunidades_riesgos.dafo_sintesis.cruces_estrategicos|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% endif %}
        {% endif %}
    </div>

    {% if scenarios %}
    <div class="seccion scenarios">
        <h1 class="seccion-titulo">Escenarios Futuros (12-24 meses)</h1>

        <div class="scenario-grid">
            {% if scenarios.best_case %}
            <div class="scenario best-case">
                <h3>🌟 Best Case ({{ (scenarios.best_case.probability * 100) | int }}%)</h3>
                {% if scenarios.best_case.drivers %}<p><strong>Drivers:</strong> {{ scenarios.best_case.drivers | join(', ') }}</p>{% endif %}
                {% if scenarios.best_case.description %}<p><strong>Descripción:</strong> {{ scenarios.best_case.description }}</p>{% endif %}
                {% if scenarios.best_case.impact %}
                <div class="scenario-impact"><strong>Impacto Esperado:</strong> {{ scenarios.best_case.impact }}</div>
                {% endif %}
                {% if scenarios.best_case.recommended_actions %}
                <p><strong>Acciones Recomendadas:</strong></p>
                <ul>
                    {% for action in scenarios.best_case.recommended_actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endif %}

            {% if scenarios.base_case %}
            <div class="scenario base-case">
                <h3>➡️ Base Case ({{ (scenarios.base_case.probability * 100) | int }}%)</h3>
                {% if scenarios.base_case.drivers %}<p><strong>Drivers:</strong> {{ scenarios.base_case.drivers | join(', ') }}</p>{% endif %}
                {% if scenarios.base_case.description %}<p><strong>Descripción:</strong> {{ scenarios.base_case.description }}</p>{% endif %}
                {% if scenarios.base_case.impact %}
                <div class="scenario-impact"><strong>Impacto Esperado:</strong> {{ scenarios.base_case.impact }}</div>
                {% endif %}
                {% if scenarios.base_case.recommended_actions %}
                <p><strong>Acciones Recomendadas:</strong></p>
                <ul>
                    {% for action in scenarios.base_case.recommended_actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endif %}

            {% if scenarios.worst_case %}
            <div class="scenario worst-case">
                <h3>⚠️ Worst Case ({{ (scenarios.worst_case.probability * 100) | int }}%)</h3>
                {% if scenarios.worst_case.drivers %}<p><strong>Drivers:</strong> {{ scenarios.worst_case.drivers | join(', ') }}</p>{% endif %}
                {% if scenarios.worst_case.description %}<p><strong>Descripción:</strong> {{ scenarios.worst_case.description }}</p>{% endif %}
                {% if scenarios.worst_case.impact %}
                <div class="scenario-impact"><strong>Impacto Esperado:</strong> {{ scenarios.worst_case.impact }}</div>
                {% endif %}
                {% if scenarios.worst_case.recommended_actions %}
                <p><strong>Acciones Recomendadas:</strong></p>
                <ul>
                    {% for action in scenarios.worst_case.recommended_actions %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {# Sección ROI eliminada a petición del usuario #}
    <!-- PLAN DE ACCIÓN 90 DÍAS - NARRATIVO -->
    <div class="seccion">
        <h1 class="seccion-titulo">Plan de Acción 90 Días</h1>
        
        {% if charts.timeline_chart %}
        <div class="chart-container">
            <img src="{{ charts.timeline_chart }}" alt="Timeline 90 Días" class="chart-img">
            <div class="chart-caption">
                Gráfico 5: Timeline de implementación del Plan de Acción a 90 días
            </div>
        </div>
        {% endif %}
        
        {# NUEVO: Narrativa de estrategia del plan #}
        {% if plan_90_dias.narrativa_estrategia %}
        <div class="narrativa-plan">
            <p class="narrative-text">{{ plan_90_dias.narrativa_estrategia|safe|replace('\n\n', '</p><p class="narrative-text">')|replace('\n', '<br>') }}</p>
        </div>
        {% endif %}
        
        {% if plan_90_dias.iniciativas %}
        <h2>Detalle de Iniciativas</h2>
        {% for iniciativa in plan_90_dias.iniciativas %}
        <div class="iniciativa-box">
            <div class="iniciativa-header">
                <h3 class="iniciativa-titulo">{{ iniciativa.titulo }}</h3>
                <span class="prioridad prioridad-{{ iniciativa.prioridad|lower }}">{{ iniciativa.prioridad }}</span>
            </div>
            
            {% if iniciativa.descripcion %}
            <div class="iniciativa-seccion">
                <strong>QUÉ:</strong> {{ iniciativa.descripcion|safe|replace('\n', '<br>') }}
            </div>
            {% endif %}
            
            {% if iniciativa.por_que %}
            <div class="iniciativa-seccion">
                <strong>POR QUÉ:</strong> {{ iniciativa.por_que|safe|replace('\n', '<br>') }}
            </div>
            {% endif %}
            
            {% if iniciativa.como %}
            <div class="iniciativa-seccion">
                <strong>CÓMO:</strong> {{ iniciativa.como|safe|replace('\n', '<br>') }}
            </div>
            {% endif %}

            {% if iniciativa.kpi_medicion %}
            <div class="iniciativa-kpi">
                <strong>KPI de medición:</strong> {{ iniciativa.kpi_medicion|safe|replace('\n', '<br>') }}
            </div>
            {% endif %}
            
            {% if iniciativa.timeline %}
            <div class="iniciativa-timeline">
                <strong>CUÁNDO:</strong> {{ iniciativa.timeline }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- ANEXOS -->
    <div class="seccion anexos">
        <h1 class="seccion-titulo">Anexos</h1>
        
        <h2>Metodología</h2>
        <p>
            Este informe ha sido generado automáticamente mediante un sistema de inteligencia 
            competitiva multi-agente que analiza respuestas de 4 modelos de IA líderes 
            (GPT-4, Claude, Gemini, Perplexity) a preguntas estructuradas sobre el mercado y marcas.
        </p>
        
        <p>
            El sistema procesa las respuestas mediante 7 agentes especializados:
        </p>
        <ul>
            <li><strong>Quantitative Agent:</strong> Análisis cuantitativo y SOV</li>
            <li><strong>Sentiment Agent:</strong> Análisis de sentimiento y reputación</li>
            <li><strong>Attributes Agent:</strong> Atributos y percepciones de marca</li>
            <li><strong>Competitive Agent:</strong> Análisis competitivo</li>
            <li><strong>Trends Agent:</strong> Identificación de tendencias</li>
            <li><strong>Strategic Agent:</strong> Análisis estratégico</li>
            <li><strong>Executive Agent:</strong> Síntesis y recomendaciones</li>
        </ul>
        
        <h2>Métricas de Calidad</h2>
        <table class="metricas-table">
            <tbody>
                <tr>
                    <td><strong>Hallazgos identificados:</strong></td>
                    <td>{{ metricas_calidad.hallazgos or 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Oportunidades detectadas:</strong></td>
                    <td>{{ metricas_calidad.oportunidades or 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Riesgos identificados:</strong></td>
                    <td>{{ metricas_calidad.riesgos or 'N/A' }}</td>
                </tr>
                <tr>
                    <td><strong>Iniciativas en plan 90 días:</strong></td>
                    <td>{{ metricas_calidad.plan_acciones or 'N/A' }}</td>
                </tr>
            </tbody>
        </table>
        
        <div class="disclaimer">
            <strong>Nota:</strong> Este informe es una herramienta de inteligencia competitiva 
            basada en análisis automatizado. Las recomendaciones deben ser validadas por expertos 
            del sector antes de implementarse.
        </div>
    </div>

    <!-- FOOTER EN TODAS LAS PÁGINAS -->
    <div class="page-footer">
        TwoLaps Intelligence Platform | {{ periodo }} | Confidencial
    </div>
</body>
</html>
